generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Attachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Category {
  id     String   @id @default(cuid())
  name   String   @unique
  Course Course[]
}

model ConfidenceRating {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  rating    Int
  createdAt DateTime @default(now())
  Lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([userId])
}

model Conversation {
  id                    String          @id @default(cuid())
  threadId              String
  lessonId              String?
  contextType           String          @default("general")
  currentTopic          String?
  summary               String?
  status                String          @default("active")
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @default(now()) @updatedAt
  awaitingResponse      Boolean         @default(false)
  lastActivityType      String?
  pendingAssessmentType String?
  Lesson                Lesson?         @relation(fields: [lessonId], references: [id])
  Thread                Thread          @relation(fields: [threadId], references: [id], onDelete: Cascade)
  Message               Message[]
  SarvamSession         SarvamSession[]

  @@index([lessonId])
  @@index([threadId])
}

model Course {
  id                 String       @id @default(cuid())
  title              String
  description        String?
  thumbnail          String?
  price              Float?
  difficulty         String       @default("beginner")
  estimatedDuration  Int          @default(0)
  learningObjectives String[]     @default([])
  isPublished        Boolean      @default(false)
  categoryId         String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @default(now()) @updatedAt
  course_id          String?
  slug               String?      @unique
  Attachment         Attachment[]
  Category           Category?    @relation(fields: [categoryId], references: [id])
  Enrollment         Enrollment[]
  Lesson             Lesson[]
  Module             Module[]
  TaskGraph          TaskGraph[]

  @@index([categoryId])
}

model Enrollment {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  enrolledAt DateTime @default(now())
  status     String   @default("active")
  Course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([userId])
}

model LearningProfile {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  preferredLearningStyle String   @default("mixed")
  learningPace           String   @default("moderate")
  interests              String[] @default([])
  strengths              String[] @default([])
  improvementAreas       String[] @default([])
  createdAt              DateTime @default(now())
  updatedAt              DateTime @default(now()) @updatedAt
  User                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Lesson {
  id               String             @id @default(cuid())
  moduleId         String
  title            String
  description      String?
  type             String             @default("lecture")
  orderIndex       Int                @default(0)
  isPublished      Boolean            @default(false)
  kpointVideoId    String?
  youtubeVideoId   String?
  duration         Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @default(now()) @updatedAt
  courseId         String
  slug             String?
  ConfidenceRating ConfidenceRating[]
  Conversation     Conversation[]
  Course           Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Module           Module             @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  LessonProgress   LessonProgress[]

  @@index([courseId])
  @@index([moduleId])
}

model LessonProgress {
  id                   String    @id @default(cuid())
  userId               String
  lessonId             String
  status               String    @default("not_started")
  watchTime            Int       @default(0)
  completionPercentage Float     @default(0)
  lastPosition         Int       @default(0)
  lastAccessedAt       DateTime  @default(now())
  completedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @default(now()) @updatedAt
  Lesson               Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  User                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([lessonId])
  @@index([userId])
}

model Message {
  id              String           @id @default(cuid())
  conversationId  String
  role            String
  content         String
  inputType       String           @default("text")
  audioUrl        String?
  audioDuration   Int?
  videoTimestamp  Int?
  emotions        Json?
  references      Json?
  createdAt       DateTime         @default(now())
  messageType     String           @default("general")
  Conversation    Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  MessageFeedback MessageFeedback?

  @@index([conversationId])
}

model MessageFeedback {
  id        String   @id @default(cuid())
  messageId String   @unique
  userId    String
  rating    String
  reason    String?
  createdAt DateTime @default(now())
  Message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([userId])
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  orderIndex  Int      @default(0)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  slug        String?
  Lesson      Lesson[]
  Course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Thread      Thread[]

  @@index([courseId])
}

model SarvamSession {
  id             String       @id @default(cuid())
  sessionId      String       @unique
  taskGraphId    String
  conversationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  status         String       @default("active")
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  TaskGraph      TaskGraph    @relation(fields: [taskGraphId], references: [id], onDelete: Cascade)

  @@unique([conversationId, taskGraphId])
  @@index([conversationId])
  @@index([taskGraphId])
}

model TaskGraph {
  id            String          @id @default(cuid())
  courseId      String
  type          String
  graphId       String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now()) @updatedAt
  SarvamSession SarvamSession[]
  Course        Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, type])
  @@index([courseId])
}

model Thread {
  id           String         @id @default(cuid())
  userId       String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @default(now()) @updatedAt
  moduleId     String
  Conversation Conversation[]
  Module       Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  User         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([moduleId])
  @@index([userId])
}

model User {
  id               String             @id @default(cuid())
  email            String             @unique
  phone            String?            @unique
  passwordHash     String
  name             String
  avatar           String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @default(now()) @updatedAt
  lastLoginAt      DateTime?
  ConfidenceRating ConfidenceRating[]
  Enrollment       Enrollment[]
  LearningProfile  LearningProfile?
  LessonProgress   LessonProgress[]
  MessageFeedback  MessageFeedback[]
  Thread           Thread[]
}
