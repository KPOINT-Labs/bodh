generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  phone             String?            @unique
  passwordHash      String?            @db.Text
  name              String
  avatar            String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLoginAt       DateTime?
  confidenceRatings ConfidenceRating[]
  enrollments       Enrollment[]
  faAttempts        FAAttempt[]
  learningProfile   LearningProfile?
  lessonProgress    LessonProgress[]
  messageFeedbacks  MessageFeedback[]
  threads           Thread[]
}

model LearningProfile {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  preferredLearningStyle String   @default("mixed")
  learningPace           String   @default("moderate")
  interests              String[] @default([])
  strengths              String[] @default([])
  improvementAreas       String[] @default([])
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Course {
  id                 String       @id @default(cuid())
  title              String
  description        String?
  thumbnail          String?
  price              Float?
  difficulty         String       @default("beginner")
  estimatedDuration  Int          @default(0)
  learningObjectives String[]     @default([])
  isPublished        Boolean      @default(false)
  categoryId         String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  course_id          String?      @unique
  slug               String?      @unique
  attachments        Attachment[]
  category           Category?    @relation(fields: [categoryId], references: [id])
  enrollments        Enrollment[]
  modules            Module[]
  lessons            Lesson[]
  taskGraphs         TaskGraph[]

  @@index([categoryId])
}

model Category {
  id      String   @id @default(cuid())
  name    String   @unique
  courses Course[]
}

model Attachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  orderIndex  Int      @default(0)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  slug        String?
  lessons     Lesson[]
  threads     Thread[]
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Lesson {
  id                String             @id @default(cuid())
  moduleId          String
  courseId          String
  title             String
  description       String?
  type              String             @default("lecture")
  orderIndex        Int                @default(0)
  isPublished       Boolean            @default(false)
  kpointVideoId     String?
  youtubeVideoId    String?
  serviceDomain     String             @default("bodh.kpoint.com")
  duration          Int                @default(0)
  quiz              Json? // Quiz configuration/data for this lesson
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  slug              String?
  confidenceRatings ConfidenceRating[]
  conversations     Conversation[]
  module            Module             @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  course            Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress          LessonProgress[]

  @@index([moduleId])
  @@index([courseId])
}

model Enrollment {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  enrolledAt DateTime @default(now())
  status     String   @default("active")
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model LessonProgress {
  id                   String    @id @default(cuid())
  userId               String
  lessonId             String
  status               String    @default("not_started")
  watchTime            Int       @default(0)
  completionPercentage Float     @default(0)
  lastPosition         Int       @default(0)
  lastAccessedAt       DateTime  @default(now())
  completedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  lesson               Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Thread {
  id            String         @id @default(cuid())
  userId        String
  moduleId      String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  conversations Conversation[]
  module        Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
}

model Conversation {
  id                    String          @id @default(cuid())
  threadId              String
  lessonId              String?
  contextType           String          @default("general")
  currentTopic          String?
  summary               String?
  status                String          @default("active")
  pendingAssessmentType String? // 'warmup' | 'in_lesson' | 'concept_check'
  awaitingResponse      Boolean         @default(false)
  lastActivityType      String? // 'qna' | 'fa' | 'general'
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  lesson                Lesson?         @relation(fields: [lessonId], references: [id])
  thread                Thread          @relation(fields: [threadId], references: [id], onDelete: Cascade)
  messages              Message[]
  sarvamSessions        SarvamSession[]

  @@index([threadId])
  @@index([lessonId])
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  role           String // 'user' | 'assistant' | 'system'
  content        String
  inputType      String           @default("text")
  messageType    String           @default("general") // 'general' | 'qna' | 'fa'
  audioUrl       String?
  audioDuration  Int?
  videoTimestamp Int?
  emotions       Json?
  references     Json?
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  faAttempts     FAAttempt[]
  feedback       MessageFeedback?

  @@index([conversationId])
}

model MessageFeedback {
  id        String   @id @default(cuid())
  messageId String   @unique
  userId    String
  rating    String
  reason    String?
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([userId])
}

model ConfidenceRating {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  rating    Int
  createdAt DateTime @default(now())
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
}

model TaskGraph {
  id             String          @id @default(cuid())
  courseId       String
  type           String // QnA, FA, etc.
  graphId        String // External graph ID
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  course         Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  sarvamSessions SarvamSession[]

  @@unique([courseId, type])
  @@index([courseId])
}

model SarvamSession {
  id             String       @id @default(cuid())
  sessionId      String       @unique // Session ID from Sarvam API
  taskGraphId    String
  conversationId String
  status         String       @default("active")
  turnCount      Int          @default(0) // Track turns for rate limit rotation (max 20 per session)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  taskGraph      TaskGraph    @relation(fields: [taskGraphId], references: [id], onDelete: Cascade)
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, taskGraphId])
  @@index([taskGraphId])
  @@index([conversationId])
}

model FAAttempt {
  id           String   @id @default(cuid())
  userId       String
  messageId    String // Reference to the FA question message
  question     String // The question text
  answer       String // User's answer
  isCorrect    Boolean? // Null if correctness is not determined
  isAttempted  Boolean  @default(true)
  questionType String? // 'multiple_choice' | 'short_answer' | 'numerical' | 'long_answer'
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
  message      Message  @relation(fields: [messageId], references: [id])

  @@unique([userId, messageId])
  @@index([userId])
  @@index([messageId])
}

model TTSCache {
  id         String   @id @default(cuid())
  textHash   String   @unique
  text       String   @db.Text
  audioData  String   @db.Text
  voice      String
  speed      Float
  model      String
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now()) @updatedAt

  @@index([textHash])
  @@index([lastUsedAt])
}
