generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  phone             String?            @unique
  passwordHash      String
  name              String
  avatar            String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastLoginAt       DateTime?
  confidenceRatings ConfidenceRating[]
  enrollments       Enrollment[]
  learningProfile   LearningProfile?
  lessonProgress    LessonProgress[]
  messageFeedbacks  MessageFeedback[]
  threads           Thread[]
}

model LearningProfile {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  preferredLearningStyle String   @default("mixed")
  learningPace           String   @default("moderate")
  interests              String[] @default([])
  strengths              String[] @default([])
  improvementAreas       String[] @default([])
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Course {
  id                 String       @id @default(cuid())
  course_id          String?      @unique // Custom user-defined ID
  title              String
  slug               String?      @unique
  description        String?
  thumbnail          String?
  price              Float?
  difficulty         String       @default("beginner")
  estimatedDuration  Int          @default(0)
  learningObjectives String[]     @default([])
  isPublished        Boolean      @default(false)
  categoryId         String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  attachments        Attachment[]
  category           Category?    @relation(fields: [categoryId], references: [id])
  enrollments        Enrollment[]
  modules            Module[]
  lessons            Lesson[]     @relation("CourseToLesson")
  threads            Thread[]

  @@index([categoryId])
}

model Category {
  id      String   @id @default(cuid())
  name    String   @unique
  courses Course[]
}

model Attachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  slug        String?
  description String?
  orderIndex  Int      @default(0)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lessons     Lesson[]
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Lesson {
  id                String             @id @default(cuid())
  moduleId          String
  courseId          String
  title             String
  slug              String?
  description       String?
  type              String             @default("lecture")
  orderIndex        Int                @default(0)
  isPublished       Boolean            @default(false)
  kpointVideoId     String?
  youtubeVideoId    String?
  duration          Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  confidenceRatings ConfidenceRating[]
  conversations     Conversation[]
  module            Module             @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  course            Course             @relation("CourseToLesson", fields: [courseId], references: [id], onDelete: Cascade)
  progress          LessonProgress[]

  @@index([moduleId])
  @@index([courseId])
}

model Enrollment {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  enrolledAt DateTime @default(now())
  status     String   @default("active")
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model LessonProgress {
  id                   String    @id @default(cuid())
  userId               String
  lessonId             String
  status               String    @default("not_started")
  watchTime            Int       @default(0)
  completionPercentage Float     @default(0)
  lastPosition         Int       @default(0)
  lastAccessedAt       DateTime  @default(now())
  completedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  lesson               Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Thread {
  id            String         @id @default(cuid())
  userId        String
  courseId      String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  conversations Conversation[]
  course        Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Conversation {
  id           String    @id @default(cuid())
  threadId     String
  lessonId     String?
  contextType  String    @default("general")
  currentTopic String?
  summary      String?
  status       String    @default("active")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lesson       Lesson?   @relation(fields: [lessonId], references: [id])
  thread       Thread    @relation(fields: [threadId], references: [id], onDelete: Cascade)
  messages     Message[]

  @@index([threadId])
  @@index([lessonId])
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  content        String
  inputType      String           @default("text")
  audioUrl       String?
  audioDuration  Int?
  videoTimestamp Int?
  emotions       Json?
  references     Json?
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  feedback       MessageFeedback?

  @@index([conversationId])
}

model MessageFeedback {
  id        String   @id @default(cuid())
  messageId String   @unique
  userId    String
  rating    String
  reason    String?
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([userId])
}

model ConfidenceRating {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String
  rating    Int
  createdAt DateTime @default(now())
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
}
